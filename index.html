<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>رسم الشموع</title>
  <style>
    body { font-family: sans-serif; direction: rtl; text-align: center; }
    #chart { width: 100%; height: 400px; border:1px solid #aaa; margin-top:10px; }
    textarea { width: 90%; height: 150px; }
    .error { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h2>📊 برنامج عرض الشموع</h2>

  <button id="btnSample">تحميل عينة</button>
  <br><br>

  <textarea id="txtData" placeholder="لصق بياناتك هنا (CSV: تاريخ,فتح,أعلى,أدنى,إغلاق,حجم)"></textarea>
  <br>
  <button id="btnLoad">تحميل من الأسفل</button>
  <div id="error" class="error"></div>

  <canvas id="chart"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
  <script>
    const ctx = document.getElementById('chart').getContext('2d');
    const errorDiv = document.getElementById('error');

    let chart = new Chart(ctx, {
      type: 'candlestick',
      data: { datasets: [{ label: 'الأسعار', data: [] }] },
    });

    // دالة تحويل التاريخ إلى timestamp
    function toTs(val){
      if(!val) return Date.now()/1000;
      let d = new Date(val);
      if(isNaN(d)) return Date.now()/1000;
      return d.getTime()/1000;
    }

    // تحميل البيانات إلى الشارت
    function loadData(rows){
      errorDiv.textContent = "";
      chart.data.datasets[0].data = rows.map(r => ({
        x: new Date(r.time*1000),
        o: r.open, h: r.high, l: r.low, c: r.close
      }));
      chart.update();
    }

    // عند الضغط على زر تحميل من الأسفل
    document.getElementById('btnLoad').onclick = ()=>{
      const txt = document.getElementById('txtData').value.trim();
      if(!txt){ errorDiv.textContent = "⚠️ الرجاء لصق البيانات."; return; }

      let lines = txt.split(/\n+/);
      let out=[];
      for(let i=0;i<lines.length;i++){
        let parts = lines[i].split(/[,\t]/); // فاصلة أو تبويب
        if(parts.length<5) continue;

        let t = parts[0].trim();
        let o = parseFloat(parts[1].replace(/,/g,""));
        let h = parseFloat(parts[2].replace(/,/g,""));
        let l = parseFloat(parts[3].replace(/,/g,""));
        let c = parseFloat(parts[4].replace(/,/g,""));
        let v = parts[5] ? parseFloat(parts[5].replace(/[^\d.-]/g,"")) : 0;

        // ✅ التحقق من القيم
        if(isNaN(o)||isNaN(h)||isNaN(l)||isNaN(c)){
          errorDiv.textContent = `⚠️ خطأ في الصف ${i+1}: قيم غير رقمية.`;
          continue;
        }

        out.push({
          time: toTs(t),
          open:+o, high:+h, low:+l, close:+c, volume:+(v||0)
        });
      }
      if(out.length>0) loadData(out);
    };

    // زر تحميل عينة
    document.getElementById('btnSample').onclick = ()=>{
      const n=30;
      let t = Math.floor(Date.now()/1000) - n*86400;
      const out=[]; 
      let price=100;
      for (let i=0;i<n;i++){
        let open=price;
        let close=open+(Math.random()-0.5)*10;
        let high=Math.max(open,close)+Math.random()*5;
        let low =Math.min(open,close)-Math.random()*5;
        price=close;
        out.push({time:t,open,high,low,close,volume:1000});
        t+=86400;
      }
      loadData(out);
    };
  </script>
</body>
</html>
