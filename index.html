<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ø±Ø³Ù… Ø§Ù„Ø´Ù…ÙˆØ¹</title>
  <style>
    body { font-family: sans-serif; direction: rtl; text-align: center; }
    #chart { width: 100%; height: 400px; border:1px solid #aaa; margin-top:10px; }
    textarea { width: 90%; height: 150px; }
    .error { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h2>ğŸ“Š Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¹Ø±Ø¶ Ø§Ù„Ø´Ù…ÙˆØ¹</h2>

  <button id="btnSample">ØªØ­Ù…ÙŠÙ„ Ø¹ÙŠÙ†Ø©</button>
  <br><br>

  <textarea id="txtData" placeholder="Ù„ØµÙ‚ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù‡Ù†Ø§ (CSV: ØªØ§Ø±ÙŠØ®,ÙØªØ­,Ø£Ø¹Ù„Ù‰,Ø£Ø¯Ù†Ù‰,Ø¥ØºÙ„Ø§Ù‚,Ø­Ø¬Ù…)"></textarea>
  <br>
  <button id="btnLoad">ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„</button>
  <div id="error" class="error"></div>

  <canvas id="chart"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
  <script>
    const ctx = document.getElementById('chart').getContext('2d');
    const errorDiv = document.getElementById('error');

    let chart = new Chart(ctx, {
      type: 'candlestick',
      data: { datasets: [{ label: 'Ø§Ù„Ø£Ø³Ø¹Ø§Ø±', data: [] }] },
    });

    // Ø¯Ø§Ù„Ø© ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¥Ù„Ù‰ timestamp
    function toTs(val){
      if(!val) return Date.now()/1000;
      let d = new Date(val);
      if(isNaN(d)) return Date.now()/1000;
      return d.getTime()/1000;
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø±Øª
    function loadData(rows){
      errorDiv.textContent = "";
      chart.data.datasets[0].data = rows.map(r => ({
        x: new Date(r.time*1000),
        o: r.open, h: r.high, l: r.low, c: r.close
      }));
      chart.update();
    }

    // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„
    document.getElementById('btnLoad').onclick = ()=>{
      const txt = document.getElementById('txtData').value.trim();
      if(!txt){ errorDiv.textContent = "âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù„ØµÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª."; return; }

      let lines = txt.split(/\n+/);
      let out=[];
      for(let i=0;i<lines.length;i++){
        let parts = lines[i].split(/[,\t]/); // ÙØ§ØµÙ„Ø© Ø£Ùˆ ØªØ¨ÙˆÙŠØ¨
        if(parts.length<5) continue;

        let t = parts[0].trim();
        let o = parseFloat(parts[1].replace(/,/g,""));
        let h = parseFloat(parts[2].replace(/,/g,""));
        let l = parseFloat(parts[3].replace(/,/g,""));
        let c = parseFloat(parts[4].replace(/,/g,""));
        let v = parts[5] ? parseFloat(parts[5].replace(/[^\d.-]/g,"")) : 0;

        // âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚ÙŠÙ…
        if(isNaN(o)||isNaN(h)||isNaN(l)||isNaN(c)){
          errorDiv.textContent = `âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØµÙ ${i+1}: Ù‚ÙŠÙ… ØºÙŠØ± Ø±Ù‚Ù…ÙŠØ©.`;
          continue;
        }

        out.push({
          time: toTs(t),
          open:+o, high:+h, low:+l, close:+c, volume:+(v||0)
        });
      }
      if(out.length>0) loadData(out);
    };

    // Ø²Ø± ØªØ­Ù…ÙŠÙ„ Ø¹ÙŠÙ†Ø©
    document.getElementById('btnSample').onclick = ()=>{
      const n=30;
      let t = Math.floor(Date.now()/1000) - n*86400;
      const out=[]; 
      let price=100;
      for (let i=0;i<n;i++){
        let open=price;
        let close=open+(Math.random()-0.5)*10;
        let high=Math.max(open,close)+Math.random()*5;
        let low =Math.min(open,close)-Math.random()*5;
        price=close;
        out.push({time:t,open,high,low,close,volume:1000});
        t+=86400;
      }
      loadData(out);
    };
  </script>
</body>
</html>
